name: Deploy to GCP

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to GCP VM
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.GCP_VM_IP }}
          username: ${{ secrets.GCP_VM_USER }}
          key: ${{ secrets.GCP_SSH_KEY }}
          command_timeout: 20m
          script: |
            cd /home/${{ secrets.GCP_VM_USER }}/no-lose

            # Pull latest code
            git pull origin main

            # Show disk space and container status
            echo "=== Disk space ==="
            df -h / | tail -1

            echo "=== Before deploy ==="
            docker compose -f docker-compose.prod.yml ps

            # CRITICAL: Free disk space BEFORE building
            echo "=== Cleaning up disk space ==="
            docker system prune -af --volumes 2>/dev/null || true
            docker builder prune -af 2>/dev/null || true
            echo "Disk after cleanup:"
            df -h / | tail -1

            # Build and start all containers (force recreate to pick up code changes)
            docker compose -f docker-compose.prod.yml up -d --build --force-recreate

            # Wait for postgres to be healthy
            echo "Waiting for postgres to be healthy..."
            for i in $(seq 1 30); do
              if docker compose -f docker-compose.prod.yml exec -T postgres pg_isready -U wa_user -d wa_database 2>/dev/null; then
                echo "Postgres is ready!"
                break
              fi
              echo "Waiting... ($i/30)"
              sleep 3
            done

            # Run database migrations
            docker compose -f docker-compose.prod.yml exec -T backend alembic upgrade head || echo "Migration warning (may be ok if tables exist)"

            # Post-deploy cleanup
            docker system prune -f 2>/dev/null || true

            # Show final status
            echo "=== After deploy ==="
            docker compose -f docker-compose.prod.yml ps
            echo "=== Disk space ==="
            df -h / | tail -1

            # Show recent logs for debugging
            echo "=== Postgres logs ==="
            docker compose -f docker-compose.prod.yml logs --tail=10 postgres
            echo "=== Backend logs ==="
            docker compose -f docker-compose.prod.yml logs --tail=10 backend
