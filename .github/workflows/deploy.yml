name: Deploy to GCP

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to GCP VM
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.GCP_VM_IP }}
          username: ${{ secrets.GCP_VM_USER }}
          key: ${{ secrets.GCP_SSH_KEY }}
          command_timeout: 30m
          script: |
            cd /home/${{ secrets.GCP_VM_USER }}/no-lose

            # Pull latest code
            git pull origin main

            # Show disk space
            echo "=== Disk space ==="
            df -h / | tail -1

            # Clean up only dangling images and build cache (preserve named volumes and cached layers!)
            echo "=== Cleaning up ==="
            docker system prune -f 2>/dev/null || true
            docker builder prune -f --keep-storage=500MB 2>/dev/null || true
            echo "Disk after cleanup:"
            df -h / | tail -1

            # Build and start all containers
            docker compose -f docker-compose.prod.yml up -d --build --force-recreate

            # Wait for postgres to be healthy
            echo "Waiting for postgres to be healthy..."
            for i in $(seq 1 30); do
              if docker compose -f docker-compose.prod.yml exec -T postgres pg_isready -U wa_user -d wa_database 2>/dev/null; then
                echo "Postgres is ready!"
                break
              fi
              echo "Waiting... ($i/30)"
              sleep 3
            done

            # Ensure wa_evolution database exists (for Evolution API)
            docker compose -f docker-compose.prod.yml exec -T postgres psql -U wa_user -d wa_database -tc "SELECT 1 FROM pg_database WHERE datname = 'wa_evolution'" | grep -q 1 || \
              docker compose -f docker-compose.prod.yml exec -T postgres psql -U wa_user -d wa_database -c "CREATE DATABASE wa_evolution OWNER wa_user;" || true

            # Run database migrations
            docker compose -f docker-compose.prod.yml exec -T backend alembic upgrade head || echo "Migration warning (may be ok if tables exist)"

            # Post-deploy cleanup (dangling only)
            docker system prune -f 2>/dev/null || true

            # Show final status
            echo "=== After deploy ==="
            docker compose -f docker-compose.prod.yml ps
            df -h / | tail -1

            echo "=== Postgres logs ==="
            docker compose -f docker-compose.prod.yml logs --tail=10 postgres
            echo "=== Backend logs ==="
            docker compose -f docker-compose.prod.yml logs --tail=10 backend
